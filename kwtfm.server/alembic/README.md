# Миграции базы данных с использованием Alembic

## Установка и настройка Alembic

1. **Установите Alembic:**

   ```bash
   pip install alembic
   ```

2. **Инициализация Alembic:**

   ```bash
   alembic init alembic
   ```

3. **Импорт моделей в `alembic/env.py`:**

   ```python
   from app.models.base import DBModelBase
   from app.models.user import UserModel
   from app.models.posting import PostingModel
   from app.models.outbound import OutboundModel
   from app.models.inbound import InboundModel
   from app.models.token import Token
   from app.models.word import Word

   target_metadata = DBModelBase.metadata
   ```

## Создание и применение миграций

1. **Внесите изменения в модели SQLAlchemy.**

2. **Создайте новую миграцию:**

   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```

3. **Проверьте файл миграции на корректность.**

4. **Примените миграцию:**

   ```bash
   alembic upgrade head
   ```

## Вставка данных через миграции

Пример для вставки администратора:

1. **Создайте миграцию.**

   ```bash
   alembic revision -m "Add admin user"
   ```

2. **Отредактируйте файл миграции:**

   Добавьте команды для вставки администратора в `upgrade()` и удаления его в `downgrade()`.

3. **Примените миграцию:**

   ```bash
   alembic upgrade head
   ```


## Общие рекомендации

- **Контроль версий:** Всегда фиксируйте миграции в системе контроля версий (например, Git).
- **Резервное копирование:** Перед применением миграций на продакшене всегда делайте резервные копии базы данных.
- **Проверка миграций:** Всегда проверяйте содержимое миграционных файлов перед их применением.


**Управление триггерами и функциями:**

При необходимости изменения логики триггеров и функций создавайте новые миграции, добавляя соответствующие SQL-команды.

---

## **Заключение**

Теперь вы можете безопасно управлять изменениями схемы базы данных, не опасаясь потери данных или некорректных изменений.

**Основные моменты:**

- **Импорт моделей:** Убедитесь, что все модели импортируются в `alembic/env.py`, чтобы Alembic мог их распознать.
- **Данные через миграции:** Добавляйте вставку данных (например, администратора) через отдельные миграции.